package uts.isd.model.dao;

import uts.isd.model.Account;

import java.sql.*;


public class AccountDAO {
    /**
     * Used to determine the type of a specified account.
     * Useful when trying to log the user in as either a Customer or Staff.
     *
     * @param email Email of Account
     * @param password Password of Account
     * @return Character representing the account type. Either 'C' or 'S'.
     * @throws SQLException When db access cannot be established.
     * @throws DAOException When account cannot be found.
     */
    public static char getAccountType(String email, String password) throws SQLException, DAOException {
        String accountTypeQuery =
                "SELECT ACCOUNT_TYPE FROM ACCOUNTS " +
                "WHERE EMAIL LIKE ? AND PASSWORD LIKE ?";

        PreparedStatement accountTypeSt = DAOUtils.prepareStatement(accountTypeQuery, false, email, password);
        ResultSet accountTypeRs = accountTypeSt.executeQuery();

        if (!accountTypeRs.next())
            throw new DAOException("No Account found. Incorrect Email or Password.");

        return accountTypeRs.getString("ACCOUNT_TYPE").charAt(0);
    }

    /**
     * Saves Account information to the database, creating a new row.
     * Returns the auto-generated primary key ID of the new account.
     * Use a try catch with DAOException to catch and display errors to the user.
     *
     * @param account The Account to save to the database.
     * @return The auto-generated ID of the new account.
     * @throws SQLException When db access cannot be established.
     * @throws DAOException When account creation fails.
     */
    public static int save(Account account) throws SQLException, DAOException {
        String query =
                "INSERT INTO ACCOUNTS (EMAIL, F_NAME, L_NAME, CONTACT_NUMBER, ACCOUNT_TYPE, PASSWORD, IS_ACTIVE) " +
                "VALUES (?, ?, ?, ?, ?, ?, ?)";

        PreparedStatement accountInsertSt = DAOUtils.prepareStatement(query, true,
                account.getEmail(),
                account.getFirstName(),
                account.getLastName(),
                account.getContactNumber(),
                String.valueOf(account.getAccountType()),
                account.getPassword(),
                account.isActive()
        );

        int rowsChanged = accountInsertSt.executeUpdate();
        if (rowsChanged == 0)
            throw new DAOException("Account creation failed. Please try again.");

        // Return Auto ID that was generated by SQL Server
        return DAOUtils.getGeneratedID(accountInsertSt);
    }

    /**
     * Update a single account from the database.
     *
     * @param account The instantiated account to update. Must have an ID.
     */
    public static void update(Account account) throws SQLException, DAOException {
        String updateQuery =
                "UPDATE ACCOUNTS SET F_NAME = ?,L_NAME = ?, EMAIL = ?, PASSWORD = ?,CONTACT_NUMBER = ?, IS_ACTIVE = ? " +
                "WHERE ID = ?";

        PreparedStatement updateSt = DAOUtils.prepareStatement(updateQuery, false,
                account.getFirstName(),
                account.getLastName(),
                account.getEmail(),
                account.getPassword(),
                account.getContactNumber(),
                account.isActive(),
                account.getID()
        );

        int rowsChanged = updateSt.executeUpdate();
        if (rowsChanged == 0)
            throw new DAOException("Failed to update Account. Please try again.");
    }

    /**
     * Delete a single account from the database.
     *
     * @param accountID ID of the account to delete.
     */
    public static void delete(String accountID) throws SQLException, DAOException {
        String deleteQuery = "DELETE FROM ACCOUNTS WHERE ID = " + accountID;

        PreparedStatement st = DAOUtils.prepareStatement(deleteQuery, false);

        int rowsChanged = st.executeUpdate();
        if (rowsChanged == 0)
            throw new DAOException("Failed to delete Account. Please try again.");
    }
}
